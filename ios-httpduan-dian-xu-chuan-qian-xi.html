<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    IOS Http断点续传浅析
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="/theme/css/normalize.css">
        <link href='//fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=PT+Mono' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="/theme/css/main.css">

    <link rel="stylesheet" href="/theme/css/blog.css">
    <link rel="stylesheet" href="/theme/css/github.css">
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="eric的博客 Atom Feed" />
        <script src="/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
        <a id="site-title" href="/"><h1><i class="icon-coffee"></i> eric的博客</h1></a>
        <p id="site-desc"></p>
    </hgroup>
    <nav>
        <ul class="navbar" id="nav-links">
            <li><a href="/category/c.html">C</a></li>
            <li class="active"><a href="/category/ios.html">iOS</a></li>
            <li><a href="/category/ndk.html">NDK</a></li>
            <li><a href="/category/python.html">Python</a></li>
        </ul> 
        <ul id="nav-links">
        </ul>
    </nav>
</header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <time class="post-time" datetime="2013-08-09T15:32:00+02:00" pubdate>
                            2013-08-09 15:32
                        </time>
                        <a href="/ios-httpduan-dian-xu-chuan-qian-xi.html" rel="bookmark"><h1>IOS Http断点续传浅析</h1></a>
                    </header>

                    <section class="post-content">
                        <p><strong>http实现断点续传的关键地方就是在httprequest中加入“Range”头。</strong></p>
<div class="highlight"><pre><span class="c1">//设置Range头，值:bytes=x-y;x:开始字节，y:结束字节，不指定则为文件末尾</span>
<span class="p">[</span><span class="n">request</span> <span class="nl">addValue</span><span class="p">:</span><span class="s">@&quot;bytes=500-&quot;</span> <span class="nl">forHTTPHeaderField</span><span class="p">:</span><span class="s">@&quot;Range&quot;</span><span class="p">];</span>
</pre></div>


<p>如果服务器正确响应的话，就可以顺利续传；如果服务器不支持，那就只能用其它方法了。</p>
<p><strong>经过测试，服务器的不支持分为两种情况：</strong></p>
<p><strong>1.完全没响应</strong></p>
<p>如果不处理会导致文件无法下载。</p>
<p>测试地址：http://dl_dir.qq.com/qqfile/qq/QQforMac/QQ_V2.4.2.dmg</p>
<p>发送请求后，过一段时间直接进入了didFailWithError的delegate;错误信息为time out。</p>
<p>针对这种情况可以做出的处理是：增加一个是否支持断点续传的标志。</p>
<p>具体：</p>
<p>第一次请求，开始字节为0，不用发送Range头，可以正常下载；</p>
<p>当下载中断，开始第二次请求，开始字节不为0，发送range头；</p>
<p>如果进入didFailWithError的delegate,就标明此链接不可以断点续传，每次请求前都清除缓存，保证开始的字节为0，不发送Range头。</p>
<p><strong>2.无论发送Range的值是多少，服务器都会重新下载。</strong></p>
<p>如果不处理，会导致续传过的文件出错。</p>
<p>测试地址：https://github.com/CocoaPods/CocoaPods/archive/master.zip</p>
<p>这种情况的处理方案是：</p>
<p>第一次收到响应的时候，就把文件的总大小记录下来；</p>
<p>以后每次收到响应的时候都比较一下下载长度和总大小是不是一样；</p>
<p>如果一样而且又存在缓存；就表明属于这种情况了；直接删掉缓存，重新下载。</p>
<p><strong>下面是用NSURLConnection实现http断点续传的实例：</strong></p>
<p>针对上面两种做了简单的处理，回调函数还有待添加</p>
<p>MXDownload.h文件：</p>
<div class="highlight"><pre><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>

<span class="k">@interface</span> <span class="nc">MXDownload</span> : <span class="bp">NSObject</span>

<span class="c1">//文件名路径</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">filePath</span><span class="p">;</span>

<span class="c1">//是否正在下载的标志</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">downloading</span><span class="p">;</span>

<span class="c1">//初始化</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithUrlString:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">urlString</span><span class="p">;</span>

<span class="c1">//两个状态</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">start</span><span class="p">;</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">stop</span><span class="p">;</span>

<span class="c1">//清除缓存</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">clearCache</span><span class="p">;</span>

<span class="k">@end</span>
</pre></div>


<p>MXDownload.m文件：</p>
<div class="highlight"><pre><span class="cp">#import &quot;MXDownload.h&quot;</span>
<span class="cp">#import &quot;NSString+MX.h&quot;</span>

<span class="cp">#define FILE_INFO_PLIST [NSString   pathWithName:@&quot;MXDownload/fileInfo.plist&quot;   directory:NSCachesDirectory]</span>

<span class="k">@interface</span> <span class="nc">MXDownload</span> <span class="p">(){</span>
    <span class="bp">NSURLConnection</span> <span class="o">*</span><span class="n">_urlConnection</span><span class="p">;</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">_urlString</span><span class="p">;</span>
    <span class="kt">BOOL</span> <span class="n">_downloading</span><span class="p">,</span><span class="n">_didAddRange</span><span class="p">,</span><span class="n">_shouldResume</span><span class="p">;</span>

    <span class="bp">NSString</span> <span class="o">*</span><span class="n">_fileName</span><span class="p">,</span><span class="o">*</span><span class="n">_filePath</span><span class="p">,</span> <span class="o">*</span><span class="n">_tempFilePath</span><span class="p">;</span>
    <span class="bp">NSFileHandle</span>        <span class="o">*</span><span class="n">_fileHandle</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>  <span class="n">_fileOffset</span><span class="p">,</span><span class="n">_fileSize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">MXDownload</span>
<span class="k">@synthesize</span> <span class="n">downloading</span> <span class="o">=</span> <span class="n">_downloading</span><span class="p">;</span>
<span class="k">@synthesize</span> <span class="n">filePath</span> <span class="o">=</span> <span class="n">_filePath</span><span class="p">;</span>

<span class="c1">//初始化，顺便设置下载文件和下载临时文件路径</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithUrlString:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">urlString</span><span class="p">{</span>
    <span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">){</span>
        <span class="n">_urlString</span> <span class="o">=</span> <span class="n">urlString</span><span class="p">;</span>
        <span class="n">_shouldResume</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_urlString</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_fileName</span> <span class="o">=</span> <span class="p">[</span><span class="n">_urlString</span> <span class="n">MD5</span><span class="p">];</span>
            <span class="n">_filePath</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">pathWithName</span><span class="p">:[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;MXDownload/ %@&quot;</span><span class="p">,</span><span class="n">_fileName</span><span class="p">]</span> <span class="nl">directory</span><span class="p">:</span><span class="n">NSCachesDirectory</span><span class="p">];</span>
            <span class="n">_tempFilePath</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;%@.temp&quot;</span><span class="p">,</span><span class="n">_filePath</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//开始下载</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">start</span><span class="p">{</span>
    <span class="c1">//如果正在下载，中断</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_downloading</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="c1">//没有url，也中断</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_urlString</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">//临时文件句柄</span>
    <span class="n">_fileHandle</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSFileHandle</span> <span class="nl">fileHandleForWritingAtPath</span><span class="p">:</span><span class="n">_tempFilePath</span><span class="p">];</span>
    <span class="c1">//获取本次请求下载开始的位置,如果文件不存在，就是0</span>
    <span class="n">_fileOffset</span> <span class="o">=</span> <span class="n">_fileHandle</span> <span class="o">?</span> <span class="p">[</span><span class="n">_fileHandle</span> <span class="n">seekToEndOfFile</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">//初始化请求</span>
    <span class="bp">NSMutableURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSMutableURLRequest</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithURL</span><span class="p">:[</span><span class="bp">NSURL</span>  <span class="nl">URLWithString</span><span class="p">:</span><span class="n">_urlString</span><span class="p">]];</span>
    <span class="c1">//设置缓存策略，很重要，因为文件是自己储存的，和缓存无关，所以要忽略缓存</span>
    <span class="c1">//要不然第二次请求会出错</span>
    <span class="p">[</span><span class="n">request</span> <span class="nl">setCachePolicy</span><span class="p">:</span><span class="n">NSURLRequestReloadIgnoringLocalCacheData</span><span class="p">];</span>

    <span class="c1">//最关键地方，设置Range头，值:bytes=x-y;x:开始字节，y:结束字节，不指定则为文件末尾</span>
    <span class="n">_didAddRange</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_fileOffset</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">_shouldResume</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">request</span> <span class="nl">addValue</span><span class="p">:[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;bytes=%llu-&quot;</span><span class="p">,</span><span class="n">_fileOffset</span><span class="p">]</span>    <span class="nl">forHTTPHeaderField</span><span class="p">:</span><span class="s">@&quot;Range&quot;</span><span class="p">];</span>
        <span class="n">_didAddRange</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">_urlConnection</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSURLConnection</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithRequest</span><span class="p">:</span><span class="n">request</span> <span class="nl">delegate</span><span class="p">:</span><span class="nb">self</span><span class="p">];</span>
    <span class="p">[</span><span class="n">_urlConnection</span> <span class="n">start</span><span class="p">];</span>

    <span class="n">_downloading</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//结束下载</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">stop</span><span class="p">{</span>
    <span class="p">[</span><span class="n">_urlConnection</span> <span class="n">cancel</span><span class="p">];</span>
    <span class="n">_urlConnection</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">[</span><span class="n">_fileHandle</span> <span class="n">closeFile</span><span class="p">];</span>
    <span class="n">_downloading</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//清除文件</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">clearCache</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_downloading</span><span class="p">)</span> <span class="p">[</span><span class="nb">self</span> <span class="n">stop</span><span class="p">];</span>
    <span class="p">[[</span><span class="bp">NSFileManager</span> <span class="n">defaultManager</span><span class="p">]</span> <span class="nl">removeItemAtPath</span><span class="p">:</span><span class="n">_filePath</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="p">[[</span><span class="bp">NSFileManager</span> <span class="n">defaultManager</span><span class="p">]</span> <span class="nl">removeItemAtPath</span><span class="p">:</span><span class="n">_tempFilePath</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>

<span class="cp">#pragma mark -</span>
<span class="cp">#pragma mark NSURLConnectionDelegate</span>

<span class="c1">//接收到响应</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connection:</span><span class="p">(</span><span class="bp">NSURLConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span> <span class="nf">didReceiveResponse:</span><span class="p">(</span><span class="bp">NSURLResponse</span>  <span class="o">*</span><span class="p">)</span><span class="nv">response</span><span class="p">{</span>
    <span class="c1">//本次请求回来的文件大小</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">fileLength</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">expectedContentLength</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fileLength</span> <span class="o">==</span> <span class="n">NSURLResponseUnknownLength</span><span class="p">)</span> <span class="p">[</span><span class="nb">self</span> <span class="n">stop</span><span class="p">];</span>

    <span class="bp">NSData</span> <span class="o">*</span><span class="n">existFileData</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSData</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithContentsOfFile</span><span class="p">:</span><span class="n">_filePath</span><span class="p">];</span>

    <span class="c1">//检查文件是否已下载完成</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">existFileData</span> <span class="o">&amp;&amp;</span> <span class="n">existFileData</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">fileLength</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;之前已经下载好了&quot;</span><span class="p">);</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">stop</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="c1">//保存文件的总大小</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_didAddRange</span><span class="p">){</span>
            <span class="bp">NSMutableDictionary</span> <span class="o">*</span><span class="n">dic</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableDictionary</span> <span class="n">new</span><span class="p">];</span>
            <span class="p">[</span><span class="n">dic</span> <span class="nl">addEntriesFromDictionary</span><span class="p">:[</span><span class="bp">NSDictionary</span>     <span class="nl">dictionaryWithContentsOfFile</span><span class="p">:</span><span class="n">FILE_INFO_PLIST</span><span class="p">]];</span>
            <span class="p">[</span><span class="n">dic</span> <span class="nl">setValue</span><span class="p">:[</span><span class="bp">NSNumber</span> <span class="nl">numberWithLongLong</span><span class="p">:</span><span class="n">fileLength</span><span class="p">]</span>  <span class="nl">forKey</span><span class="p">:</span><span class="n">_fileName</span><span class="p">];</span>
            <span class="p">[</span><span class="n">dic</span> <span class="nl">writeToFile</span><span class="p">:</span><span class="n">FILE_INFO_PLIST</span> <span class="nl">atomically</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="bp">NSFileManager</span> <span class="o">*</span><span class="n">fileManager</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSFileManager</span> <span class="n">defaultManager</span><span class="p">];</span>
        <span class="c1">//先清除掉旧的文件</span>
        <span class="p">[</span><span class="n">fileManager</span> <span class="nl">removeItemAtPath</span><span class="p">:</span><span class="n">_filePath</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>

        <span class="c1">//如果此次请求回来的大小等于文件的总大小而且临时文件又存在，则删除临时文件</span>
        <span class="c1">//解决每次请求都是重新开始的问题</span>
        <span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">dic</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSDictionary</span> <span class="nl">dictionaryWithContentsOfFile</span><span class="p">:</span><span class="n">FILE_INFO_PLIST</span><span class="p">];</span>
        <span class="kt">BOOL</span> <span class="n">isTotalLength</span> <span class="o">=</span> <span class="n">fileLength</span> <span class="o">==</span> <span class="p">[[</span><span class="n">dic</span> <span class="nl">valueForKey</span><span class="p">:</span><span class="n">_fileName</span><span class="p">]</span> <span class="n">longLongValue</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">fileManager</span> <span class="nl">fileExistsAtPath</span><span class="p">:</span><span class="n">_tempFilePath</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">isTotalLength</span><span class="p">){</span>
            <span class="p">[</span><span class="n">fileManager</span> <span class="nl">removeItemAtPath</span><span class="p">:</span><span class="n">_tempFilePath</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="c1">//重新创建文件</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">fileManager</span> <span class="nl">fileExistsAtPath</span><span class="p">:</span><span class="n">_tempFilePath</span><span class="p">]){</span>
            <span class="p">[</span><span class="n">fileManager</span> <span class="nl">createFileAtPath</span><span class="p">:</span><span class="n">_tempFilePath</span> <span class="nl">contents</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">attributes</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
            <span class="n">_fileHandle</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSFileHandle</span> <span class="nl">fileHandleForWritingAtPath</span><span class="p">:</span><span class="n">_tempFilePath</span><span class="p">];</span>
            <span class="n">_fileOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">_fileSize</span> <span class="o">=</span> <span class="n">fileLength</span> <span class="o">+</span> <span class="n">_fileOffset</span><span class="p">;</span>

        <span class="c1">//用_fileOffset可以检查是重新下载还是继续下载</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span><span class="n">_fileOffset</span> <span class="o">?</span> <span class="s">@&quot;继续下载&quot;</span> <span class="o">:</span> <span class="s">@&quot;开始下载&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//不断接收到数据</span>
<span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connection:</span><span class="p">(</span><span class="bp">NSURLConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span> <span class="nf">didReceiveData:</span><span class="p">(</span><span class="bp">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">aData</span><span class="p">{</span>
    <span class="c1">//写入文件</span>
    <span class="p">[</span><span class="n">_fileHandle</span> <span class="nl">writeData</span><span class="p">:</span><span class="n">aData</span><span class="p">];</span>
    <span class="n">_fileOffset</span> <span class="o">=</span> <span class="p">[</span><span class="n">_fileHandle</span> <span class="n">offsetInFile</span><span class="p">];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;下载进度: %lld / %lld&quot;</span><span class="p">,</span><span class="n">_fileOffset</span><span class="p">,</span><span class="n">_fileSize</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connection:</span><span class="p">(</span><span class="bp">NSURLConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span> <span class="nf">didFailWithError:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span><span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">stop</span><span class="p">];</span>
    <span class="c1">//如果不支持续传，删掉临时文件再试一次</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_shouldResume</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_shouldResume</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
        <span class="p">[[</span><span class="bp">NSFileManager</span> <span class="n">defaultManager</span><span class="p">]</span> <span class="nl">removeItemAtPath</span><span class="p">:</span><span class="n">_tempFilePath</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">start</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//完成</span>
<span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connectionDidFinishLoading:</span><span class="p">(</span><span class="bp">NSURLConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span><span class="p">{</span>
    <span class="p">[[</span><span class="bp">NSFileManager</span> <span class="n">defaultManager</span><span class="p">]</span> <span class="nl">moveItemAtPath</span><span class="p">:</span><span class="n">_tempFilePath</span> <span class="nl">toPath</span><span class="p">:</span><span class="n">_filePath</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;下载完成&quot;</span><span class="p">);</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">stop</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</pre></div>


<p>调用：</p>
<div class="highlight"><pre><span class="p">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">startDownLoad:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_downloader</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">){</span>
<span class="c1">//        _downloader = [[MXDownload alloc] initWithUrlString:@&quot;https://github.com/ CocoaPods/CocoaPods/archive/master.zip&quot;];</span>
        <span class="n">_downloader</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MXDownload</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithUrlString</span><span class="p">:</span><span class="s">@&quot;http://dl_dir.qq.com/ qqfile/qq/QQforMac/QQ_V2.4.2.dmg&quot;</span><span class="p">];</span>
<span class="c1">//        _downloader = [[MXDownload alloc] initWithUrlString:@&quot;http:// 192.168.50.19:8080/vcont/wb.mp3&quot;];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_downloader</span><span class="p">.</span><span class="n">downloading</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">_downloader</span> <span class="n">stop</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="p">[</span><span class="n">_downloader</span> <span class="n">start</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="/category/ios.html">iOS</a></p>
                        <p>Tags: <a href="/tag/ios.html">iOS</a>, </p>
                    </aside>
                    <hr/>
                </article>
            </li>
        </ol>
<footer id="site-info">
    <p>
        Proudly powered by <a href="http://getpelican.com/">Pelican</a> and <a href="http://python.org/">Python</a>. Theme by<a href="https://github.com/hdra/pelican-cait">hndr</a>.
    </p>
</footer>    </div>
        </div>
        <script src="/theme/js/main.js"></script>
    </body>
</html>
<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, height=device-width, initial-scale=1">
    <meta name="author" content="Eric Long" />
    <meta name="copyright" content="Eric Long" />
    <meta property="og:type" content="article" />

<meta name="keywords" content="Other, Other, " />

    <title>小米电视、Mac、SMB</title>
<script type="text/javascript" src="/theme/js/jquery-1.12.0.min.js"></script>
<script type="text/javascript" src="/theme/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/theme/tipuesearch/tipuesearch_set.js"></script>
<script type="text/javascript" src="/theme/tipuesearch/tipuesearch.min.js"></script>
<link rel="stylesheet" href="/theme/css/bootstrap.min.css" />
<link rel="stylesheet" href="/theme/css/font-awesome.min.css" />
<link rel="stylesheet" type="text/css" href="/theme/tipuesearch/tipuesearch.css" media="screen">
<link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" media="screen">
<link rel="stylesheet" type="text/css" href="/theme/css/swain.css" media="screen">
<link rel="stylesheet" type="text/css" href="/theme/css/animate.css" media="screen">
    <link rel="icon" href="/theme/images/favicon.ico" type="image/x-icon" />
    
    <!-- GOOGLE_ANALYTICS -->
</head>
<body>
    <!-- navbar start -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <i class="fa fa-bars fa-lg fa-inverse"></i>
                </button>
                <a class="navbar-brand" href="/">万象天青</a>
            </div>

            <div class="collapse navbar-collapse navbar-right" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li ><a href="/">首页</a></li>
                    <!-- <li ><a href="/categories.html">分类</a></li> -->
                    <li ><a href="/tags.html">标签</a></li>
                    <li ><a href="/archives.html">归档</a></li>
                </ul>
                <!-- 
                <form class="navbar-search navbar-form navbar-right" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query form-control" placeholder="Search" name="q" id="tipue_search_input"></form>
                -->
            </div>
        </div>
    </nav>
    <!-- navbar end -->
    <div class="container-fluid" id="container">
        <div class="row-fluid">
<div class="col-md-2 hidden-xs hidden-sm" id="sidebar_left">
</div>
            <div class="col-md-8" id="center_page">
<section id="content" class="body fadeInUp">
  <article>
    <div class="panel panel-default">
      <div class="panel-body">
        <header>
          <h1 class="entry-title">
            <a href="/xiao-mi-dian-shi-mac-smb.html" rel="bookmark"
               title="Permalink to 小米电视、Mac、SMB">小米电视、Mac、<span class="caps">SMB</span></a></h1>
        </header>
        <div class="tagged">
                <i class="fa fa-calendar"></i><time class="article-li-time">2019-09-26 15:20</time>
                <i class="fa fa-folder-open fa-lg"></i>
                <a class="tagged" href="/categories.html#other-ref">Other</a>
                <i class="fa fa-tags"></i>
                    <a class="tagged" href="/tags.html#other-ref">Other</a>
        </div>
        <hr/>
        <div class="entry-content">
          <h2>0x00前言</h2>
<p>小米电视上有个应用叫【高清播放器】，此播放器可以连接开启了【共享】功能的设备</p>
<p>通过此功能可以在大屏上浏览其它设备上的文件</p>
<p>通常我都是在电脑上下载好后，再转到电视上Enjoy</p>
<p><img alt="MacDown logo" src="/images/mac_smb/1.JPG"></p>
<p><img alt="MacDown logo" src="/images/mac_smb/2.JPG"></p>
<p><img alt="MacDown logo" src="/images/mac_smb/3.JPG"></p>
<p><img alt="MacDown logo" src="/images/mac_smb/4.JPG"></p>
<h2>0x01问题</h2>
<p>问题就是死活也连不上MacBook</p>
<p>用户名和密码完全正确也还是有下面的提示</p>
<p><img alt="MacDown logo" src="/images/mac_smb/5.JPG"></p>
<p>在Windows上是可以连得上的</p>
<p><img alt="MacDown logo" src="/images/mac_smb/6.JPG"></p>
<p><img alt="MacDown logo" src="/images/mac_smb/7.JPG"></p>
<p>这完全就是个BUG啊</p>
<p>最近有点时间，所以决定深入探究一下</p>
<h2>0x02原因</h2>
<p>搜索一翻得到的答案是小米电视的samba和Mac的smbd不兼容</p>
<p>所以目前在网上并没有一个比较完美的解决方案</p>
<h2>0x03方案</h2>
<p>既然不兼容，那就把兼容问题解决了就好，三个方案</p>
<p><strong>1、改小米电视的samba版本</strong></p>
<p><strong>2、改Mac上的smbd</strong></p>
<p><strong>3、都不改，用一个兼容的版本代替Mac上的smbd</strong></p>
<p>对比起来，方案3是比较容易的，所以选定方案3开工</p>
<h2>0x04解决过程</h2>
<p>直接起个samba服务</p>
<div class="highlight"><pre><span></span><span class="nt">docker</span> <span class="nt">run</span> <span class="nt">-it</span> <span class="nt">--name</span> <span class="nt">samba</span> <span class="nt">-p</span> <span class="nt">139</span><span class="p">:</span><span class="nd">139</span> <span class="nt">-p</span> <span class="nt">445</span><span class="p">:</span><span class="nd">445</span> <span class="nt">-v</span> <span class="o">~/</span><span class="nt">Downloads</span><span class="o">:/</span><span class="nt">shares</span> <span class="nt">-d</span> <span class="nt">dperson</span><span class="o">/</span><span class="nt">samba</span> <span class="nt">-s</span> <span class="s2">&quot;shares;/shares;yes;yes;yes;&quot;</span> <span class="nt">-S</span>
</pre></div>


<p>可能会出现这个错误</p>
<div class="highlight"><pre><span></span><span class="n">Error</span> <span class="n">starting</span> <span class="n">userland</span> <span class="n">proxy</span><span class="p">:</span> <span class="k">listen</span> <span class="n">tcp</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">:</span><span class="mi">445</span><span class="p">:</span> <span class="n">bind</span><span class="p">:</span> <span class="n">address</span> <span class="n">already</span> <span class="k">in</span> <span class="n">use</span><span class="p">.</span>
</pre></div>


<p><img alt="MacDown logo" src="/images/mac_smb/8.jpg"></p>
<p>445端口被占用了，因为之前开启了smbd，smbd占用了445</p>
<p><img alt="MacDown logo" src="/images/mac_smb/9.jpg"></p>
<p>关掉系统的共享功能再重试，成功</p>
<p><img alt="MacDown logo" src="/images/mac_smb/10.jpg"></p>
<p>查看下445端口的情况</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">lsof</span> <span class="o">-</span><span class="n">i</span><span class="p">:</span><span class="mi">445</span>
</pre></div>


<p><img alt="MacDown logo" src="/images/mac_smb/11.jpg"></p>
<p>但是，即使是成功了，还是连接不上</p>
<p>猜测应该是还有其他服务一起限制，单是开了445端口是不行的</p>
<p>于是重新打开系统的共享功能，由于docker已经占了445端口，所以系统的smbd是启动不了的，成功替换</p>
<p><img alt="MacDown logo" src="/images/mac_smb/12.jpg"></p>
<h2>0x05解决步骤</h2>
<p>1、关闭共享功能</p>
<p>2、开启新的samba服务</p>
<p>3、打开共享功能</p>
<h2>0x06进一步</h2>
<p>写个脚本来解决</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="nv">SHARE_DIR</span><span class="o">=</span>~/Downloads

<span class="nv">SMBD</span><span class="o">=</span>/System/Library/LaunchDaemons/com.apple.smbd.plist

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="k">$(</span>docker ps <span class="p">|</span> grep <span class="s2">&quot;samba&quot;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">STOPED</span><span class="o">=</span><span class="nb">true</span>
<span class="k">else</span>
    <span class="nv">STOPED</span><span class="o">=</span><span class="nb">false</span>
<span class="k">fi</span>

stop<span class="o">(){</span>
    sudo launchctl unload -w <span class="nv">$SMBD</span>
    sudo sed -i <span class="s2">&quot;&quot;</span> <span class="s1">&#39;s/&lt;string&gt;\/usr\/sbin\/smbd -ports &quot;446&quot;&lt;\/string&gt;/&lt;string&gt;\/usr\/sbin\/smbd&lt;\/string&gt;/g&#39;</span> <span class="nv">$SMBD</span>
    <span class="k">if</span> ! <span class="nv">$STOPED</span><span class="p">;</span> <span class="k">then</span>
        docker rm -f samba
    <span class="k">fi</span>
<span class="o">}</span>

force_start<span class="o">(){</span>
    stop
    docker run -it --name samba -p <span class="m">139</span>:139 -p <span class="m">445</span>:445 -v <span class="nv">$SHARE_DIR</span>:/shares -d dperson/samba -s <span class="s2">&quot;shares;/shares;yes;yes;yes;&quot;</span> -S
    sudo sed -i <span class="s2">&quot;&quot;</span> <span class="s1">&#39;s/&lt;string&gt;\/usr\/sbin\/smbd&lt;\/string&gt;/&lt;string&gt;\/usr\/sbin\/smbd -ports &quot;446&quot;&lt;\/string&gt;/g&#39;</span> <span class="nv">$SMBD</span>
    sudo launchctl load -w <span class="nv">$SMBD</span>
<span class="o">}</span>

start<span class="o">(){</span>
    <span class="k">if</span> <span class="nv">$STOPED</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;===starting===&quot;</span>
        force_start
        <span class="nb">echo</span> <span class="s2">&quot;===started===&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    start
<span class="k">else</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        start
    <span class="k">elif</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">=</span> <span class="s2">&quot;stop&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;===stoping===&quot;</span>
        stop
        <span class="nb">echo</span> <span class="s2">&quot;===stoped===&quot;</span>
    <span class="k">elif</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">=</span> <span class="s2">&quot;restart&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;===restarting===&quot;</span>
        force_start
        <span class="nb">echo</span> <span class="s2">&quot;===restarted===&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="nb">exit</span>
</pre></div>
</td></tr></table>

<p>保存为samba.sh，用起来就简单了</p>
<div class="highlight"><pre><span></span><span class="n">sh</span> <span class="n">samba</span><span class="p">.</span><span class="n">sh</span> <span class="k">start</span><span class="o">/</span><span class="k">restart</span><span class="o">/</span><span class="n">stop</span>
</pre></div>


<h2>0x07踩坑记录</h2>
<h4>samba</h4>
<div class="highlight"><pre><span></span><span class="nt">docker</span> <span class="nt">run</span> <span class="nt">-it</span> <span class="nt">--name</span> <span class="nt">samba</span> <span class="nt">-p</span> <span class="nt">139</span><span class="p">:</span><span class="nd">139</span> <span class="nt">-p</span> <span class="nt">445</span><span class="p">:</span><span class="nd">445</span> <span class="nt">-v</span> <span class="o">~/</span><span class="nt">Downloads</span><span class="o">:/</span><span class="nt">shares</span> <span class="nt">-d</span> <span class="nt">dperson</span><span class="o">/</span><span class="nt">samba</span> <span class="nt">-s</span> <span class="s2">&quot;shares;/shares;yes;yes;yes;&quot;</span> <span class="nt">-S</span>
</pre></div>


<p>命令最后有个&#8221;-S&#8221;参数，这个是关键，表示&#8221;Disable <span class="caps">SMB2</span> minimum&nbsp;version&#8221;</p>
<p>具体可参看<a href="https://hub.docker.com/r/dperson/samba">https://hub.docker.com/r/dperson/samba</a></p>
<p>如果不加这个参数，在电视上是连接不了的，但在PC上可以连接</p>
<p>倒推回来，可能问题的原因是电视用的是SMB1，而Mac又放弃了对SMB1的支持，PC则同时支持SMB1~3</p>
<h4>smbd</h4>
<p>mac上用命令打开和关闭【共享】功能的命令是</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">launchctl</span> <span class="k">load</span> <span class="o">-</span><span class="n">w</span> <span class="o">/</span><span class="k">System</span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">LaunchDaemons</span><span class="o">/</span><span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">smbd</span><span class="p">.</span><span class="n">plist</span>

<span class="n">sudo</span> <span class="n">launchctl</span> <span class="n">unload</span> <span class="o">-</span><span class="n">w</span> <span class="o">/</span><span class="k">System</span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">LaunchDaemons</span><span class="o">/</span><span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">smbd</span><span class="p">.</span><span class="n">plist</span>
</pre></div>


<p>小坑：&nbsp;unload了之后，445端口有可能还没来得及关闭，这时候开samba就会出现端口被占用的问题</p>
<p>解决方法是让smbd用另外一个端口，如446，所以脚本里会有</p>
<div class="highlight"><pre><span></span><span class="n">SMBD</span><span class="o">=/</span><span class="k">System</span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">LaunchDaemons</span><span class="o">/</span><span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">smbd</span><span class="p">.</span><span class="n">plist</span>

<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="ss">&quot;&quot;</span> <span class="s1">&#39;s/&lt;string&gt;\/usr\/sbin\/smbd&lt;\/string&gt;/&lt;string&gt;\/usr\/sbin\/smbd -ports &quot;446&quot;&lt;\/string&gt;/g&#39;</span> <span class="err">$</span><span class="n">SMBD</span>

<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="ss">&quot;&quot;</span> <span class="s1">&#39;s/&lt;string&gt;\/usr\/sbin\/smbd -ports &quot;446&quot;&lt;\/string&gt;/&lt;string&gt;\/usr\/sbin\/smbd&lt;\/string&gt;/g&#39;</span> <span class="err">$</span><span class="n">SMBD</span>
</pre></div>
        </div><!-- /.entry-content -->
    </div>
  </div>      




  </article>
</section>
            </div>
            <div class="col-md-2 fadeInRight" id="sidebar_right">
            </div>
        </div>
    </div>

    <!-- BAIDU_TONGJI -->

    <!-- footer -->
    <div id="push"></div>
<footer class="footer">
<div id="footer">
    <ul class="footer-content">
        <li class="swain-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>
        </li>
    </ul>
    <ul class="footer-content">
        <li class="swain-power"><a href="http://www.beian.miit.gov.cn/">桂ICP备16000282号-2</a>
        </li>
    </ul>
</div>
</footer>    
<script type="text/javascript">
    function setTocClass(){
            var f = document.getElementById("toc");
            if (f != null) {
              f.classList.add("art-toc");
              f.classList.add("fadeInLeft");
              f.style.opacity = 1;
            };
        };
    window.onload = setTocClass();
</script>
</body>
</html>